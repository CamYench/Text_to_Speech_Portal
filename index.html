<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sesame Web App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const App = () => {
      const [text, setText] = useState("");
      const [audioUrl, setAudioUrl] = useState(null);
      const [voiceId, setVoiceId] = useState("default");
      const [voices, setVoices] = useState({ default: "Default" });
      const [isRecording, setIsRecording] = useState(false);
      const [conversationMode, setConversationMode] = useState(false);
      const wavesurfer = useRef(null);
      const audioRef = useRef(null);

      useEffect(() => {
        wavesurfer.current = WaveSurfer.create({
          container: "#waveform",
          waveColor: "violet",
          progressColor: "purple",
          height: 100,
        });
        return () => wavesurfer.current.destroy();
      }, []);

      const generateAudio = async () => {
        const response = await fetch("http://localhost:5000/generate_audio", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, voice_id: voiceId }),
        });
        const data = await response.json();
        setAudioUrl(`http://localhost:5000/download/${data.audio_path}`);
        wavesurfer.current.load(audioUrl);
        audioRef.current.src = audioUrl;
        audioRef.current.play();
      };

      const handleCloneVoice = async (e) => {
        const file = e.target.files[0];
        const formData = new FormData();
        formData.append("audio", file);
        const response = await fetch("http://localhost:5000/clone_voice", {
          method: "POST",
          body: formData,
        });
        const data = await response.json();
        setVoices({ ...voices, [data.voice_id]: `Voice ${data.voice_id}` });
      };

      const startConversation = async () => {
        setConversationMode(true);
        const response = await fetch("http://localhost:5000/conversation", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: text }),
        });
        const data = await response.json();
        setAudioUrl(`http://localhost:5000/download/${data.audio_path}`);
        wavesurfer.current.load(audioUrl);
        audioRef.current.src = audioUrl;
        audioRef.current.play();
      };

      return (
        <div className="p-4 max-w-4xl mx-auto">
          <h1 className="text-2xl font-bold mb-4">Sesame Web App</h1>
          
          <textarea
            className="w-full p-2 border rounded mb-4"
            value={text}
            onChange={(e) => setText(e.target.value)}
            placeholder="Enter text to convert to speech"
          />
          
          <div className="flex space-x-4 mb-4">
            <button
              className="bg-blue-500 text-white p-2 rounded"
              onClick={generateAudio}
            >
              Generate Audio
            </button>
            <button
              className="bg-green-500 text-white p-2 rounded"
              onClick={startConversation}
            >
              {conversationMode ? "Exit Conversation" : "Start Conversation"}
            </button>
            <a
              href={audioUrl}
              download="generated_audio.wav"
              className="bg-gray-500 text-white p-2 rounded"
            >
              Download
            </a>
          </div>

          <div className="mb-4">
            <label className="block mb-2">Select Voice:</label>
            <select
              className="p-2 border rounded"
              value={voiceId}
              onChange={(e) => setVoiceId(e.target.value)}
            >
              {Object.entries(voices).map(([id, name]) => (
                <option key={id} value={id}>{name}</option>
              ))}
            </select>
          </div>

          <div className="mb-4">
            <label className="block mb-2">Clone Voice:</label>
            <input type="file" accept="audio/*" onChange={handleCloneVoice} />
          </div>

          <audio ref={audioRef} controls className="w-full mb-4" />
          <div id="waveform" className="w-full"></div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
